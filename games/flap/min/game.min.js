flap=new Game,flap.startGame=function(){function e(e){var a=String.fromCharCode(e.keyCode);"D"==a&&I()}var a=this;a.world=new b2World(new b2Vec2(0,13),!0);var t=5,n=document.getElementById("canvas");n.width=window.innerWidth,n.height=window.innerHeight,n.b2color="#9aaaFF";var r=n.width/t,o=n.height/t,l=n.getContext("2d"),i=[],d=!1;a.music=document.getElementById("birdSong"),a.music.volume=.3;for(var s=2,c=[],m=o/16,p=20,w=r/5,g=0;s>g;g++){var u=o/4+Math.random()*o/2,h=createStaticBox(a.world,r/(s+1)*(g+1)+w,u-o-p,m,o),f=new B2CanvasElement(h,t);i.push(f),c.push([(f.x()-m)*t,(f.y()-o)*t,2*m*t,2*o*t]);var y=createStaticBox(a.world,r/(s+1)*(g+1)+w,u+o+p,m,o),v=new B2CanvasElement(y,t);v.geometry="box",i.push(v),c.push([(v.x()-m)*t,(v.y()-o)*t,2*m*t,2*o*t])}var B=0,C=new Image;C.src="games/flap/images/pointerFinger1000.png",drawInstructions=function(){var e=1/(B/8);l.save(),l.beginPath(),l.arc(n.width/2,n.height/2,B,0,2*Math.PI,!0),l.closePath(),l.fillStyle="rgba(120,120,50,"+e+")",l.fill(),l.restore(),l.save(),l.drawImage(C,n.width/2,n.height/2),l.restore(),B++,B%=150},drawWalls=function(){for(var e=0;e<c.length;e++)l.save(),l.beginPath(),l.lineWidth="1",l.strokeStyle="#000000",l.fillStyle="#FFCC00",l.shadowColor="#000000",l.shadowBlur=6,l.fillRect(c[e][0],c[e][1],c[e][2],c[e][3]),l.fill(),l.stroke(),l.restore()},flapUp=new Image,flapUp.src="games/flap/images/flapUpTest.png",flapDown=new Image,flapDown.src="games/flap/images/flapDownTest.png";var b=1600,G=createBall(a.world,0,o/2,3,3);G.name="player";var S=new B2CanvasElement(G,t,flapDown);i.push(S),G.ApplyImpulse(new b2Vec2(b,0),G.GetWorldCenter());var I=function(){if(d===!1){document.getElementById("birdFlap").play();var e=S.b2dBody;S.image=flapUp,changePlayerToFlapDown=function(){S.image=flapDown},setTimeout(changePlayerToFlapDown,200);var a=e.GetLinearVelocity();e.SetLinearVelocity(new b2Vec2(a.x,0)),e.ApplyImpulse(new b2Vec2(0,-2e3),e.GetWorldCenter())}};document.addEventListener("keydown",e,!0);var x=!1;$("#canvas").bind("touchstart click",function(){localStorage["flap-tutorial-done"]=!0,x||(a.gameStarted=!0,x=!0,setTimeout(function(){x=!1},30),I())});var F=new Box2D.Dynamics.b2ContactListener;F.BeginContact=function(e){cBodyA=e.GetFixtureA().GetBody().name,cBodyB=e.GetFixtureB().GetBody().name,("player"===cBodyA||"player"===cBodyB)&&(document.getElementById("birdCollide").play(),d=!0,a.wonOrLost=!1)},a.world.SetContactListener(F),a.wonOrLost=!1,a.endGameCalledAlready=!1,a.gameStarted=!1;var D=0,L=function(){d===!0&&a.endGame(),a.gameStarted||(drawB2Graphics(n,l,i),drawWalls(),l.save(),l.fillStyle="rgba(0,0,0,0.6)",l.fillRect(0,0,n.width,n.height),l.restore(),localStorage["flap-tutorial-done"]||drawInstructions()),a.gameStarted&&(updateBox2dGame(a.world,n,l,i),drawWalls()),S.x()>r&&(d=!0,a.wonOrLost=!0),(S.y()>o||S.y()<0)&&(d=!0,a.wonOrLost=!1),D++};a.stopid=setInterval(L,4)},flap.endGame=function(){var e=this;e.endGameCalledAlready===!1&&(stopGame=function(){clearInterval(e.stopid),e.world=null,e.music.pause(),e.music.currentTime=0,context.clearRect(0,0,canvas.width,canvas.height)},setTimeout(stopGame,2e3),gameFinished(e.wonOrLost),e.endGameCalledAlready=!0)},gameObjectsArray.push(flap);