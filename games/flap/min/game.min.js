flap=new Game,flap.difficulty=0,flap.startGame=function(){function e(e){var a=String.fromCharCode(e.keyCode);"D"==a&&S()}var a=this;a.birdFlap=document.getElementById("birdFlap"),a.birdFlap.volume=.3,a.birdCollide=document.getElementById("birdCollide"),a.birdCollide.volume=.3,a.world=new b2World(new b2Vec2(0,13),!0);var l=5,t=document.getElementById("canvas");t.width=window.innerWidth,t.height=window.innerHeight,t.b2color="#9aaaFF";var n=t.width/l,r=t.height/l,o=t.getContext("2d"),i=[],s=!1;a.music=document.getElementById("birdSong"),a.music.volume=.3,numberOfWalls=0,numberOfWalls=a.difficulty<=0?2:3,movingWalls=!1,movingWalls=a.difficulty<=1?!1:!0;for(var d=[],c=[],m=r/16,f=20,u=n/5,p=0;numberOfWalls>p;p++){var w=r/6+Math.random()*r/2,g=createKinematicBox(a.world,n/(numberOfWalls+1)*(p+1)+u,w-r-f,m,r),y=new B2CanvasElement(g,l);y.isWall=!0,i.push(y),c.push([(y.x()-m)*l,(y.y()-r)*l,2*m*l,2*r*l]);var v=createKinematicBox(a.world,n/(numberOfWalls+1)*(p+1)+u,w+r+f,m,r),h=new B2CanvasElement(v,l);h.isWall=!0,i.push(h),c.push([(h.x()-m)*l,(h.y()-r)*l,2*m*l,2*r*l])}var b=.005,W=0;wallsUpAndDown=function(e){return 1==e.isWall&&(e.b2dBody.SetPosition(new b2Vec2(e.x(),e.y()+.3*Math.sin(W))),W+=b),e},updateWallPositions=function(){i=i.map(wallsUpAndDown)},generateWallCanvasInfoFromWall=function(e){return[(e.x()-m)*l,(e.y()-r)*l,2*m*l,2*r*l]},elementIsAWall=function(e){return 1==e.isWall?!0:!1},generateListOfWallCanvasInfo=function(e){return d=e.filter(elementIsAWall),d.map(generateWallCanvasInfoFromWall)};var B=0,C=new Image;C.src="games/flap/images/pointerFinger1000.png",drawInstructions=function(){var e=1/(B/8);o.save(),o.beginPath(),o.arc(t.width/2,t.height/2,B,0,2*Math.PI,!0),o.closePath(),o.fillStyle="rgba(120,120,50,"+e+")",o.fill(),o.restore(),o.save(),o.drawImage(C,t.width/2,t.height/2),o.restore(),B++,B%=150},drawWalls=function(){for(var e=0;e<c.length;e++)o.save(),o.beginPath(),o.lineWidth="1",o.strokeStyle="#000000",o.fillStyle="#FFCC00",o.shadowColor="#000000",o.shadowBlur=6,o.fillRect(c[e][0],c[e][1],c[e][2],c[e][3]),o.fill(),o.stroke(),o.restore()},flapUp=new Image,flapUp.src="games/flap/images/flapUpTest.png",flapDown=new Image,flapDown.src="games/flap/images/flapDownTest.png";var I=1600,G=createBall(a.world,0,r/2,3,3);G.name="player";var F=new B2CanvasElement(G,l,flapDown);i.push(F),G.ApplyImpulse(new b2Vec2(I,0),G.GetWorldCenter());var S=function(){if(s===!1){a.birdFlap.play();var e=F.b2dBody;F.image=flapUp,changePlayerToFlapDown=function(){F.image=flapDown},setTimeout(changePlayerToFlapDown,200);var l=e.GetLinearVelocity();e.SetLinearVelocity(new b2Vec2(l.x,0)),e.ApplyImpulse(new b2Vec2(0,-2e3),e.GetWorldCenter())}};document.addEventListener("keydown",e,!0);var O=!1;$("#canvas").bind("touchstart click",function(){localStorage["flap-tutorial-done"]=!0,O||(a.gameStarted=!0,O=!0,setTimeout(function(){O=!1},30),S())});var x=new Box2D.Dynamics.b2ContactListener;x.BeginContact=function(e){cBodyA=e.GetFixtureA().GetBody().name,cBodyB=e.GetFixtureB().GetBody().name,("player"===cBodyA||"player"===cBodyB)&&(a.birdCollide.play(),s=!0,a.wonOrLost=!1)},a.world.SetContactListener(x),a.wonOrLost=!1,a.endGameCalledAlready=!1,a.gameStarted=!1;var A=0,L=function(){s===!0&&a.endGame(),a.gameStarted||(drawB2Graphics(t,o,i),drawWalls(),o.save(),o.fillStyle="rgba(0,0,0,0.6)",o.fillRect(0,0,t.width,t.height),o.restore(),localStorage["flap-tutorial-done"]||drawInstructions()),a.gameStarted&&(updateBox2dGame(a.world,t,o,i),movingWalls&&updateWallPositions(),c=generateListOfWallCanvasInfo(i),drawWalls()),F.x()>n&&(s=!0,a.wonOrLost=!0),(F.y()>r||F.y()<0)&&(s=!0,a.wonOrLost=!1),A++};a.stopid=setInterval(L,4)},flap.endGame=function(){var e=this;e.endGameCalledAlready===!1&&(stopGame=function(){clearInterval(e.stopid),e.world=null,e.music.pause(),e.music.currentTime=0},setTimeout(stopGame,2e3),e.wonOrLost?e.difficulty++:(e.difficulty--,e.difficulty<0&&(e.difficulty=0)),gameFinished(e.wonOrLost),e.endGameCalledAlready=!0)},gameObjectsArray.push(flap);